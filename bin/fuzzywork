#!/bin/sh
# Dependancies: tmux fzf (optional but at least one fuzzyfinder menu is needed)

cd $HOME/work

WORK="$HOME/work \
	$HOME/work/coding/mia \
	$HOME/work/diplwmatiki \
	$HOME/work/academia\
	$HOME/work/academia/mathimata"

PERSONAL="$HOME/.config \
	$HOME/.local/bin \
	$HOME/.local/src"

TDIRS="$TDIRS $WORK $PERSONAL"

usage()
{
	printf "Usage $0 [OPTION] [FUZZYFINDER]\n"
	printf "\n"
	printf "Lets you select a directory via fzf, creates a tmux session with the name of the direcory and attaches to it\n"
	printf "\t--depth, -d\tchange search depth (default 2)\n"
	printf "\t--help, -h\tprints this help message\n"
	printf "\tFUZZYFINDER\tProvide an alternative to fzf, eg dmenu, rofi. Optional\n"

	printf "\n"
	printf "\n"
	printf "Manos Lefakis\n"
	exit 1
}
# setup fuzzy finder
FUZZY=fzf
DEPTH=2
while [ $# -ne 0 ]; do
	case $1 in
		help|-h|--help|-help|h)
			usage
			shift
			;;
		-d|--depth|d)
			if [ $# -ne 2 ]; then
				usage
			fi
			shift
			DEPTH=$1
			shift
			;;
		*)
			FUZZY=$1
			shift
			;;
	esac
done;

# find directory for new session
find_dir()
{
	workspace=`find $TDIRS -maxdepth $DEPTH -type d | sort -u | $FUZZY`
	_err=$?
	if [ $_err -ne 0 ]; then
		exit 1
	fi
	echo $workspace
}

# create session
create_session()
{
	name=$(basename $1 | tr . _)
	if ! tmux has-session -t $name 2> /dev/null; then
		tmux new -ds $name -c $1 > /dev/null
	fi
	echo $name
}

# attach to session
attach_to()
{
	tmux switch-client -t $1 || tmux a -t $1 
}

_wrks=`find_dir` || exit 69
_ns=`create_session $_wrks`
echo $_ns
attach_to $_ns
